service: interaction-service

frameworkVersion: ">=1.1.0 <2.0.0"

provider:
  name: aws
  runtime: nodejs10.x
  environment:
    INTERACTIONS_TABLE: interactions-${opt:stage, self:provider.stage}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
      Resource: "*"

plugins:
  - serverless-aws-documentation

custom:
  # You must have the documentation object
  documentation:
    # this is general info about the API
    api:
      info:
        version: '2'
        title: Interactions API
    models:
      -
        name: 400Response
        contentType: "application/json"
        schema:
          type: object
          properties:
            error:
              type: string
      -
        name: 500Response
        contentType: "application/json"
        schema:
          type: object
          properties:
            error:
              type: string

functions:
  authorize:
    handler: auth.handler
  login:
    handler: login.handler
    events:
      - http:
          path: login
          method: post
          cors: true
  interactions:
    handler: interactions.handler
    events:
      - http:
          path: interactions
          method: put
          cors: true
          authorizer: authorize
          documentation:
            methodResponses:
                -
                  statusCode: "400"
                  responseModels:
                    "application/json": "400Response"
                -
                  statusCode: "500"
                  responseModels:
                    "application/json": "500Response"
      - http:
          path: interactions
          method: post
          cors: true
          authorizer: authorize
          documentation:
            methodResponses:
                -
                  statusCode: "400"
                  responseModels:
                    "application/json": "400Response"
                -
                  statusCode: "500"
                  responseModels:
                    "application/json": "500Response"

resources:
  Resources:
    InteractionsDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      DeletionPolicy: Retain
      Properties:
        AttributeDefinitions:
          -
            AttributeName: "application"
            AttributeType: "S"
          -
            AttributeName: "time"
            AttributeType: "N"
        KeySchema:
          -
            AttributeName: "application"
            KeyType: "HASH"
          -
            AttributeName: "time"
            KeyType: "RANGE"
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        StreamSpecification:
          StreamViewType: "NEW_IMAGE"
        TableName: "interactions"